<!DOCTYPE html>
<html>
<head>
    <title>WASM Test 2</title>
</head>
<body>
    <h1>WASM Test 2 - With Render</h1>
    <div id="output">Loading...</div>
    <button id="test-btn">Test Button</button>
    <button id="render-btn">Render</button>
    <br><br>
    <canvas id="canvas" style="border: 1px solid black;"></canvas>

    <script type="module">
        const output = document.getElementById('output');

        // Test 1: Basic JS works
        output.textContent = 'JS loaded. ';
        console.log('Step 1: JS loaded');

        // Test 2: Button works
        document.getElementById('test-btn').addEventListener('click', () => {
            console.log('Test button clicked!');
            alert('Test button works!');
        });

        let engine = null;

        document.getElementById('render-btn').addEventListener('click', () => {
            console.log('Render button clicked!');
            if (!engine) {
                alert('Engine not ready');
                return;
            }
            try {
                engine.parse(`Frame
  width: 200px
  height: 100px
  fill: #4a90d9
  corner-radius: 8px`);
                engine.layout();
                const pngData = engine.exportPng();
                const blob = new Blob([pngData], { type: 'image/png' });
                const url = URL.createObjectURL(blob);
                const img = new Image();
                const canvas = document.getElementById('canvas');
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    canvas.getContext('2d').drawImage(img, 0, 0);
                    URL.revokeObjectURL(url);
                    output.textContent = 'Rendered!';
                };
                img.src = url;
            } catch (e) {
                alert('Render error: ' + e.message);
            }
        });

        console.log('Step 2: Event listeners attached');

        // Test 3: Import WASM
        try {
            console.log('Step 3: Attempting WASM import...');
            const module = await import('../pkg/seed_wasm.js');
            console.log('Step 4: Module imported:', Object.keys(module));
            output.textContent += 'Module imported. ';

            // Test 4: Initialize WASM
            console.log('Step 5: Calling init()...');
            await module.default();
            console.log('Step 6: WASM initialized');
            output.textContent += 'WASM init done. ';

            // Test 5: Create engine
            console.log('Step 7: Creating SeedEngine...');
            engine = new module.SeedEngine();
            console.log('Step 8: Engine created');
            output.textContent += 'Engine created. ';

            // Test 6: Get version
            console.log('Step 9: Getting version...');
            const version = module.getVersion();
            console.log('Step 10: Version:', version);
            output.textContent += 'Version: ' + version + ' - Click Render!';

        } catch (e) {
            console.error('Error:', e);
            output.textContent = 'ERROR: ' + e.message;
        }
    </script>
</body>
</html>
