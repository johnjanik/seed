<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seed Engine Demo</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 16px;
            padding: 16px;
            height: 100vh;
        }
        header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }
        h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .status {
            font-size: 0.875rem;
            padding: 4px 12px;
            border-radius: 999px;
            background: #2d2d44;
        }
        .status.ready { background: #1e3a2f; color: #4ade80; }
        .status.error { background: #3a1e1e; color: #f87171; }
        .panel {
            background: #16162a;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            padding: 12px 16px;
            background: #1e1e3a;
            font-weight: 500;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #888;
        }
        #editor {
            flex: 1;
            width: 100%;
            padding: 16px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }
        .preview-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: #fff;
            overflow: auto;
        }
        #canvas { max-width: 100%; max-height: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .preview-tabs {
            display: flex;
            gap: 0;
            background: #1e1e3a;
        }
        .preview-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 0.75rem;
            text-transform: uppercase;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .preview-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .preview-tab:hover { color: #888; }
        .comparison-container {
            flex: 1;
            display: flex;
            align-items: stretch;
            overflow: hidden;
        }
        .comparison-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: #fff;
            overflow: auto;
        }
        .comparison-pane.reference { background: #f5f5f5; border-right: 1px solid #ddd; }
        .pane-label {
            font-size: 0.625rem;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 8px;
        }
        #reference-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .reference-placeholder {
            color: #999;
            font-size: 0.875rem;
            text-align: center;
            padding: 20px;
        }
        .comparison-slider {
            display: none;
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #fff;
        }
        .comparison-slider.active { display: flex; }
        .slider-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .slider-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            overflow: hidden;
            border-right: 2px solid #667eea;
        }
        .slider-handle {
            position: absolute;
            top: 0;
            left: 50%;
            width: 4px;
            height: 100%;
            background: #667eea;
            cursor: ew-resize;
            transform: translateX(-50%);
        }
        .slider-handle::before {
            content: '◀ ▶';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.625rem;
            white-space: nowrap;
        }
        .diff-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .diff-overlay.active { display: block; }
        .opacity-slider { width: 100px; }
        .toolbar {
            grid-column: 1 / -1;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-secondary { background: #2d2d44; color: #ccc; }
        .btn-secondary:hover { background: #3d3d54; }
        .examples select {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            background: #2d2d44;
            color: #ccc;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .examples { margin-left: auto; }
        /* File converter styles */
        .converter-panel {
            grid-column: 1 / -1;
            background: #16162a;
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
        }
        .converter-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        .converter-header h2 {
            font-size: 1rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .converter-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }
        .converter-section {
            background: #1e1e3a;
            border-radius: 8px;
            padding: 16px;
        }
        .converter-section h3 {
            font-size: 0.75rem;
            color: #667eea;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        .drop-zone {
            border: 2px dashed #3d3d54;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .drop-zone-text { color: #888; font-size: 0.875rem; }
        .drop-zone-formats { color: #555; font-size: 0.75rem; margin-top: 8px; }
        .file-info {
            background: #2d2d44;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            display: none;
        }
        .file-info.visible { display: block; }
        .file-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 4px 0;
        }
        .file-info-label { color: #888; }
        .file-info-value { color: #e0e0e0; font-family: monospace; }
        .format-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
        }
        .format-seed { background: #2d5a3d; color: #4ade80; }
        .format-gltf { background: #3d4a5a; color: #60a5fa; }
        .format-step { background: #5a4a3d; color: #fbbf24; }
        .format-usd { background: #5a3d5a; color: #c084fc; }
        .convert-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .convert-options select {
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            background: #2d2d44;
            color: #ccc;
            font-size: 0.875rem;
        }
        .scene-stats {
            font-size: 0.8rem;
        }
        .scene-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        .stat-box {
            background: #2d2d44;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
        }
        .stat-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }
        .error-message {
            padding: 16px;
            background: #3a1e1e;
            color: #f87171;
            font-family: monospace;
            font-size: 0.875rem;
            display: none;
        }
        .info-bar {
            padding: 8px 16px;
            background: #1e1e3a;
            font-size: 0.75rem;
            color: #666;
            display: flex;
            gap: 16px;
        }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Seed Engine</h1>
            <span id="status" class="status">Loading...</span>
        </header>
        <div class="panel">
            <div class="panel-header">Source</div>
            <textarea id="editor" spellcheck="false">Frame:
  width: 200px
  height: 100px
  fill: #4a90d9
  corner-radius: 8px</textarea>
        </div>
        <div class="panel">
            <div class="panel-header">Preview</div>
            <div class="preview-tabs">
                <button class="preview-tab active" data-view="render">Render</button>
                <button class="preview-tab" data-view="compare">Side-by-Side</button>
                <button class="preview-tab" data-view="slider">Slider</button>
                <button class="preview-tab" data-view="diff">Diff</button>
            </div>
            <!-- Render only view -->
            <div class="preview-container" id="view-render">
                <canvas id="canvas"></canvas>
            </div>
            <!-- Side-by-side comparison view -->
            <div class="comparison-container" id="view-compare" style="display:none;">
                <div class="comparison-pane reference">
                    <div class="pane-label">Reference</div>
                    <div id="reference-placeholder" class="reference-placeholder">
                        Click "Import Reference" to load a PNG
                    </div>
                    <img id="reference-img" style="display:none;">
                </div>
                <div class="comparison-pane">
                    <div class="pane-label">Rendered</div>
                    <canvas id="canvas-compare"></canvas>
                </div>
            </div>
            <!-- Slider comparison view -->
            <div class="comparison-slider" id="view-slider">
                <img id="slider-ref" class="slider-image">
                <div class="slider-overlay" id="slider-overlay">
                    <canvas id="canvas-slider" class="slider-image"></canvas>
                </div>
                <div class="slider-handle" id="slider-handle"></div>
            </div>
            <!-- Diff view -->
            <div class="preview-container" id="view-diff" style="display:none;">
                <canvas id="canvas-diff"></canvas>
            </div>
            <div id="error-container" class="error-message"></div>
            <div class="info-bar">
                <span id="info">-</span>
                <span id="diff-info" style="display:none;">Difference: <span id="diff-percent">-</span>%</span>
            </div>
        </div>
        <div class="toolbar">
            <button class="btn-primary" id="btn-render">Render</button>
            <button class="btn-secondary" id="btn-svg">Export SVG</button>
            <button class="btn-secondary" id="btn-png">Export PNG</button>
            <button class="btn-secondary" id="btn-import">Import Reference</button>
            <button class="btn-secondary" id="btn-clear-ref" style="display:none;">Clear Reference</button>
            <input type="file" id="file-input" accept="image/png,image/jpeg,image/gif,image/webp" style="display:none;">
            <div class="examples">
                <select id="examples">
                    <option value="">Load Example...</option>
                    <option value="simple">Simple Frame</option>
                    <option value="nested">Nested Frames</option>
                    <option value="gradient">Gradients</option>
                </select>
            </div>
        </div>

        <!-- File Converter Panel -->
        <div class="converter-panel">
            <div class="converter-header">
                <h2>3D File Converter</h2>
                <span id="converter-status" class="status">Ready</span>
            </div>
            <div class="converter-content">
                <!-- Import Section -->
                <div class="converter-section">
                    <h3>Import</h3>
                    <div class="drop-zone" id="drop-zone">
                        <div class="drop-zone-text">Drop a 3D file here or click to browse</div>
                        <div class="drop-zone-formats">Supports: glTF, GLB, STEP, USD, Seed</div>
                    </div>
                    <input type="file" id="file-input-3d" accept=".gltf,.glb,.step,.stp,.usda,.usdc,.usd,.seed" style="display:none;">
                    <div class="file-info" id="file-info">
                        <div class="file-info-row">
                            <span class="file-info-label">File:</span>
                            <span class="file-info-value" id="file-name">-</span>
                        </div>
                        <div class="file-info-row">
                            <span class="file-info-label">Size:</span>
                            <span class="file-info-value" id="file-size">-</span>
                        </div>
                        <div class="file-info-row">
                            <span class="file-info-label">Format:</span>
                            <span class="file-info-value"><span id="file-format" class="format-badge">-</span></span>
                        </div>
                    </div>
                </div>

                <!-- Scene Info Section -->
                <div class="converter-section">
                    <h3>Scene Info</h3>
                    <div class="scene-stats" id="scene-stats">
                        <div class="scene-stats-grid">
                            <div class="stat-box">
                                <div class="stat-value" id="stat-nodes">-</div>
                                <div class="stat-label">Nodes</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="stat-geometries">-</div>
                                <div class="stat-label">Geometries</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="stat-materials">-</div>
                                <div class="stat-label">Materials</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="stat-roots">-</div>
                                <div class="stat-label">Roots</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Section -->
                <div class="converter-section">
                    <h3>Export</h3>
                    <div class="convert-options">
                        <select id="export-format">
                            <option value="">Select format...</option>
                            <option value="seed">Seed (.seed)</option>
                            <option value="gltf">glTF 2.0 (.glb)</option>
                            <option value="step">STEP (.step)</option>
                            <option value="usd">USD (.usda)</option>
                        </select>
                        <button class="btn-primary" id="btn-convert" disabled>Convert & Download</button>
                    </div>
                    <div id="convert-error" class="error-message" style="display:none; margin-top:12px; padding:8px; font-size:0.75rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const status = document.getElementById('status');
        const editor = document.getElementById('editor');
        const canvas = document.getElementById('canvas');
        const canvasCompare = document.getElementById('canvas-compare');
        const canvasSlider = document.getElementById('canvas-slider');
        const canvasDiff = document.getElementById('canvas-diff');
        const errorContainer = document.getElementById('error-container');
        const info = document.getElementById('info');
        const diffInfo = document.getElementById('diff-info');
        const diffPercent = document.getElementById('diff-percent');
        const fileInput = document.getElementById('file-input');
        const referenceImg = document.getElementById('reference-img');
        const referencePlaceholder = document.getElementById('reference-placeholder');
        const sliderRef = document.getElementById('slider-ref');
        const sliderOverlay = document.getElementById('slider-overlay');
        const sliderHandle = document.getElementById('slider-handle');
        const btnClearRef = document.getElementById('btn-clear-ref');

        status.textContent = 'JS loaded...';
        console.log('Step 1: JS loaded');

        let engine = null;
        let wasmModule = null;
        let referenceDataUrl = null;
        let currentView = 'render';
        let lastRenderedDataUrl = null;

        const EXAMPLES = {
            simple: `Frame:
  width: 200px
  height: 100px
  fill: #4a90d9
  corner-radius: 8px`,
            nested: `Frame:
  width: 300px
  height: 200px
  fill: #2d2d44
  corner-radius: 12px

  Frame:
    width: 120px
    height: 80px
    x: 20px
    y: 20px
    fill: #667eea

  Frame:
    width: 120px
    height: 80px
    x: 160px
    y: 100px
    fill: #764ba2
    corner-radius: 40px`,
            gradient: `Frame:
  width: 300px
  height: 200px
  fill: linear-gradient(135deg, #667eea 0%, #764ba2 100%)
  corner-radius: 16px`
        };

        // View tab handling
        document.querySelectorAll('.preview-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentView = tab.dataset.view;
                updateView();
            });
        });

        function updateView() {
            document.getElementById('view-render').style.display = currentView === 'render' ? 'flex' : 'none';
            document.getElementById('view-compare').style.display = currentView === 'compare' ? 'flex' : 'none';
            document.getElementById('view-slider').style.display = currentView === 'slider' ? 'flex' : 'none';
            document.getElementById('view-diff').style.display = currentView === 'diff' ? 'flex' : 'none';
            diffInfo.style.display = currentView === 'diff' && referenceDataUrl ? 'inline' : 'none';

            if (currentView !== 'render' && lastRenderedDataUrl) {
                updateComparisonViews();
            }
        }

        function updateComparisonViews() {
            if (!lastRenderedDataUrl) return;

            // Update side-by-side comparison canvas
            const img = new Image();
            img.onload = () => {
                canvasCompare.width = img.width;
                canvasCompare.height = img.height;
                canvasCompare.getContext('2d').drawImage(img, 0, 0);

                // Update slider canvas
                canvasSlider.width = img.width;
                canvasSlider.height = img.height;
                canvasSlider.getContext('2d').drawImage(img, 0, 0);

                // Update diff if reference exists
                if (referenceDataUrl && currentView === 'diff') {
                    computeDiff();
                }
            };
            img.src = lastRenderedDataUrl;
        }

        function computeDiff() {
            if (!referenceDataUrl || !lastRenderedDataUrl) return;

            const refImg = new Image();
            const renderedImg = new Image();
            let loadedCount = 0;

            const onBothLoaded = () => {
                loadedCount++;
                if (loadedCount < 2) return;

                const width = Math.max(refImg.width, renderedImg.width);
                const height = Math.max(refImg.height, renderedImg.height);

                canvasDiff.width = width;
                canvasDiff.height = height;
                const ctx = canvasDiff.getContext('2d');

                // Draw reference
                const refCanvas = document.createElement('canvas');
                refCanvas.width = width;
                refCanvas.height = height;
                const refCtx = refCanvas.getContext('2d');
                refCtx.fillStyle = '#fff';
                refCtx.fillRect(0, 0, width, height);
                refCtx.drawImage(refImg, 0, 0);
                const refData = refCtx.getImageData(0, 0, width, height);

                // Draw rendered
                const renderedCanvas = document.createElement('canvas');
                renderedCanvas.width = width;
                renderedCanvas.height = height;
                const renderedCtx = renderedCanvas.getContext('2d');
                renderedCtx.fillStyle = '#fff';
                renderedCtx.fillRect(0, 0, width, height);
                renderedCtx.drawImage(renderedImg, 0, 0);
                const renderedData = renderedCtx.getImageData(0, 0, width, height);

                // Compute difference
                const diffData = ctx.createImageData(width, height);
                let diffPixels = 0;
                const totalPixels = width * height;

                for (let i = 0; i < refData.data.length; i += 4) {
                    const dr = Math.abs(refData.data[i] - renderedData.data[i]);
                    const dg = Math.abs(refData.data[i + 1] - renderedData.data[i + 1]);
                    const db = Math.abs(refData.data[i + 2] - renderedData.data[i + 2]);
                    const diff = (dr + dg + db) / 3;

                    if (diff > 5) { // Threshold for "different"
                        diffPixels++;
                        // Highlight differences in red
                        diffData.data[i] = 255;
                        diffData.data[i + 1] = 0;
                        diffData.data[i + 2] = 0;
                        diffData.data[i + 3] = Math.min(255, diff * 3);
                    } else {
                        // Show original (dimmed)
                        diffData.data[i] = renderedData.data[i];
                        diffData.data[i + 1] = renderedData.data[i + 1];
                        diffData.data[i + 2] = renderedData.data[i + 2];
                        diffData.data[i + 3] = 128;
                    }
                }

                ctx.putImageData(diffData, 0, 0);

                const diffPercentage = ((diffPixels / totalPixels) * 100).toFixed(2);
                diffPercent.textContent = diffPercentage;
                diffInfo.style.display = 'inline';
            };

            refImg.onload = onBothLoaded;
            renderedImg.onload = onBothLoaded;
            refImg.src = referenceDataUrl;
            renderedImg.src = lastRenderedDataUrl;
        }

        // Import reference button - imports image and generates starter code
        document.getElementById('btn-import').addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                // Read file as both DataURL (for display) and ArrayBuffer (for WASM)
                const [dataUrl, arrayBuffer] = await Promise.all([
                    readFileAsDataUrl(file),
                    file.arrayBuffer()
                ]);

                referenceDataUrl = dataUrl;
                referenceImg.src = referenceDataUrl;
                referenceImg.style.display = 'block';
                referencePlaceholder.style.display = 'none';
                sliderRef.src = referenceDataUrl;
                btnClearRef.style.display = 'inline-block';

                // Analyze image using Rust WASM analyzer
                if (wasmModule) {
                    status.textContent = 'Analyzing image...';
                    const pngBytes = new Uint8Array(arrayBuffer);
                    try {
                        const seedCode = wasmModule.analyzePng(pngBytes);
                        editor.value = seedCode;
                        status.textContent = 'Ready';
                        status.classList.remove('error');
                        status.classList.add('ready');
                    } catch (analyzeError) {
                        console.error('Analysis error:', analyzeError);
                        // Fall back to simple JS-based generation
                        const img = new Image();
                        img.onload = () => {
                            editor.value = generateStarterCode(img);
                            doRender();
                            document.querySelector('[data-view="compare"]').click();
                        };
                        img.src = dataUrl;
                        return;
                    }
                }

                // Auto-render to show comparison
                doRender();

                // Switch to side-by-side view for comparison
                document.querySelector('[data-view="compare"]').click();
            } catch (err) {
                console.error('File read error:', err);
                alert('Failed to read file: ' + err.message);
            }
            fileInput.value = ''; // Reset for re-selecting same file
        });

        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Generate starter Seed code from an image
        function generateStarterCode(img) {
            const origWidth = img.width;
            const origHeight = img.height;

            // Limit render size to prevent browser hang
            const MAX_SIZE = 400;
            const scale = Math.min(1, MAX_SIZE / Math.max(origWidth, origHeight));
            const width = Math.round(origWidth * scale);
            const height = Math.round(origHeight * scale);

            // Create a smaller canvas for sampling
            const sampleCanvas = document.createElement('canvas');
            const sampleSize = Math.min(100, Math.min(origWidth, origHeight));
            const sampleScale = sampleSize / Math.max(origWidth, origHeight);
            sampleCanvas.width = Math.round(origWidth * sampleScale);
            sampleCanvas.height = Math.round(origHeight * sampleScale);
            const ctx = sampleCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0, sampleCanvas.width, sampleCanvas.height);

            // Sample colors from the scaled-down image
            const colors = sampleImageColors(ctx, sampleCanvas.width, sampleCanvas.height, scale / sampleScale);

            // Generate simple Seed code template
            let code = `Frame:\n`;
            code += `  width: ${width}px\n`;
            code += `  height: ${height}px\n`;
            code += `  fill: ${colors.background}\n`;

            return code;
        }

        // Sample colors from image
        function sampleImageColors(ctx, width, height, outputScale) {
            // Get all pixel data at once (more efficient)
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            // Get background color from corners
            const getPixel = (x, y) => {
                const i = (y * width + x) * 4;
                return { r: data[i], g: data[i+1], b: data[i+2] };
            };

            const corners = [
                getPixel(0, 0),
                getPixel(width-1, 0),
                getPixel(0, height-1),
                getPixel(width-1, height-1)
            ];

            let r = 0, g = 0, b = 0;
            corners.forEach(c => { r += c.r; g += c.g; b += c.b; });
            const bgColor = { r: Math.round(r/4), g: Math.round(g/4), b: Math.round(b/4) };

            return {
                background: rgbToHex(bgColor),
                regions: []
            };
        }

        function rgbToHex(c) {
            return '#' + [c.r, c.g, c.b].map(x => x.toString(16).padStart(2, '0')).join('');
        }

        // Clear reference button
        btnClearRef.addEventListener('click', () => {
            referenceDataUrl = null;
            referenceImg.src = '';
            referenceImg.style.display = 'none';
            referencePlaceholder.style.display = 'block';
            sliderRef.src = '';
            btnClearRef.style.display = 'none';
            diffInfo.style.display = 'none';
        });

        // Slider functionality
        let isDragging = false;
        sliderHandle.addEventListener('mousedown', () => { isDragging = true; });
        document.addEventListener('mouseup', () => { isDragging = false; });
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const rect = document.getElementById('view-slider').getBoundingClientRect();
            const x = Math.max(0, Math.min(rect.width, e.clientX - rect.left));
            const percent = (x / rect.width) * 100;
            sliderOverlay.style.width = percent + '%';
            sliderHandle.style.left = percent + '%';
        });

        // Event listeners
        document.getElementById('btn-render').addEventListener('click', doRender);

        document.getElementById('btn-svg').addEventListener('click', () => {
            if (!engine) { alert('Engine not ready'); return; }
            try {
                const svg = engine.exportSvg();
                download('seed.svg', svg, 'image/svg+xml');
            } catch (e) { alert('SVG export error: ' + e.message); }
        });

        document.getElementById('btn-png').addEventListener('click', () => {
            if (!engine) { alert('Engine not ready'); return; }
            try {
                engine.parse(editor.value);
                engine.layout();
                const pngData = engine.exportPng();
                const blob = new Blob([pngData], { type: 'image/png' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'seed.png';
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) { alert('PNG export error: ' + e.message); }
        });

        document.getElementById('examples').addEventListener('change', (e) => {
            const example = EXAMPLES[e.target.value];
            if (example) {
                editor.value = example;
                doRender();
            }
            e.target.value = '';
        });

        editor.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                doRender();
            }
        });

        console.log('Step 2: Event listeners attached');

        function doRender() {
            console.log('doRender called');
            if (!engine) { alert('Engine not ready'); return; }
            try {
                errorContainer.style.display = 'none';
                console.log('Parsing:', editor.value);
                engine.parse(editor.value);
                console.log('Parsed, computing layout...');
                engine.layout();
                console.log('Layout done, exporting PNG...');
                const pngData = engine.exportPng();
                console.log('PNG exported, size:', pngData.length);

                // Create data URL
                let binary = '';
                const chunkSize = 8192;
                for (let i = 0; i < pngData.length; i += chunkSize) {
                    const chunk = pngData.slice(i, i + chunkSize);
                    binary += String.fromCharCode.apply(null, chunk);
                }
                const base64 = btoa(binary);
                lastRenderedDataUrl = 'data:image/png;base64,' + base64;

                const blob = new Blob([pngData], { type: 'image/png' });
                const url = URL.createObjectURL(blob);

                const img = new Image();
                img.onload = () => {
                    console.log('Image loaded:', img.width, 'x', img.height);
                    canvas.width = img.width;
                    canvas.height = img.height;
                    canvas.getContext('2d').drawImage(img, 0, 0);
                    URL.revokeObjectURL(url);
                    info.textContent = img.width + ' x ' + img.height;

                    // Update comparison views if not in render-only mode
                    if (currentView !== 'render') {
                        updateComparisonViews();
                    }
                };
                img.onerror = (e) => {
                    console.error('Image load error:', e);
                    // Try data URL as fallback
                    const img2 = new Image();
                    img2.onload = () => {
                        canvas.width = img2.width;
                        canvas.height = img2.height;
                        canvas.getContext('2d').drawImage(img2, 0, 0);
                        info.textContent = img2.width + ' x ' + img2.height;
                        if (currentView !== 'render') {
                            updateComparisonViews();
                        }
                    };
                    img2.src = lastRenderedDataUrl;
                };
                img.src = url;
            } catch (e) {
                errorContainer.textContent = e.message;
                errorContainer.style.display = 'block';
            }
        }

        function download(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Load WASM
        try {
            console.log('Step 3: Loading WASM...');
            const module = await import('../pkg/seed_wasm.js');
            console.log('Step 4: Module loaded');

            await module.default();
            console.log('Step 5: WASM initialized');

            wasmModule = module;
            engine = new module.SeedEngine();
            const version = module.getVersion();
            console.log('Step 6: Ready, version:', version);

            status.textContent = 'Ready (v' + version + ')';
            status.classList.add('ready');

            doRender();

            // Initialize file converter
            initFileConverter(module);
        } catch (e) {
            console.error('Load error:', e);
            status.textContent = 'Error: ' + e.message;
            status.classList.add('error');
        }

        // ============================================
        // File Converter Functionality
        // ============================================

        let fileConverter = null;
        let currentFileData = null;
        let currentScene = null;

        function initFileConverter(module) {
            fileConverter = new module.FileConverter();

            const converterStatus = document.getElementById('converter-status');
            const dropZone = document.getElementById('drop-zone');
            const fileInput3D = document.getElementById('file-input-3d');
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            const fileFormat = document.getElementById('file-format');
            const exportFormat = document.getElementById('export-format');
            const btnConvert = document.getElementById('btn-convert');
            const convertError = document.getElementById('convert-error');

            // Log supported formats
            const readFormats = module.getSupportedReadFormats();
            const writeFormats = module.getSupportedWriteFormats();
            console.log('Supported read formats:', readFormats);
            console.log('Supported write formats:', writeFormats);

            converterStatus.textContent = 'Ready';
            converterStatus.classList.add('ready');

            // Click to browse
            dropZone.addEventListener('click', () => fileInput3D.click());

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleFileImport(file);
            });

            // File input change
            fileInput3D.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFileImport(file);
                fileInput3D.value = '';
            });

            // Export format change
            exportFormat.addEventListener('change', () => {
                btnConvert.disabled = !currentScene || !exportFormat.value;
            });

            // Convert button
            btnConvert.addEventListener('click', doConvert);

            async function handleFileImport(file) {
                converterStatus.textContent = 'Reading...';
                converterStatus.classList.remove('ready', 'error');
                convertError.style.display = 'none';

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    currentFileData = new Uint8Array(arrayBuffer);

                    // Update file info
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);

                    // Detect format
                    const detectedFormat = module.detectFileFormat(currentFileData);
                    if (detectedFormat) {
                        fileFormat.textContent = detectedFormat.toUpperCase();
                        fileFormat.className = 'format-badge format-' + detectedFormat;
                    } else {
                        fileFormat.textContent = 'Unknown';
                        fileFormat.className = 'format-badge';
                    }

                    fileInfo.classList.add('visible');

                    // Read and get stats
                    converterStatus.textContent = 'Parsing...';
                    currentScene = fileConverter.read(currentFileData);

                    // Update scene stats
                    updateSceneStats(currentScene);

                    converterStatus.textContent = 'Ready';
                    converterStatus.classList.add('ready');
                    btnConvert.disabled = !exportFormat.value;

                } catch (err) {
                    console.error('Import error:', err);
                    converterStatus.textContent = 'Error';
                    converterStatus.classList.add('error');
                    convertError.textContent = err.message || 'Failed to read file';
                    convertError.style.display = 'block';
                    currentScene = null;
                    currentFileData = null;
                    btnConvert.disabled = true;
                }
            }

            function doConvert() {
                if (!currentScene || !exportFormat.value) return;

                converterStatus.textContent = 'Converting...';
                converterStatus.classList.remove('ready', 'error');
                convertError.style.display = 'none';

                try {
                    const format = exportFormat.value;
                    const outputData = fileConverter.write(currentScene, format);

                    // Determine file extension and mime type
                    const extensions = {
                        seed: '.seed',
                        gltf: '.glb',
                        step: '.step',
                        usd: '.usda'
                    };
                    const mimeTypes = {
                        seed: 'text/plain',
                        gltf: 'model/gltf-binary',
                        step: 'application/step',
                        usd: 'text/plain'
                    };

                    const ext = extensions[format] || '.bin';
                    const mime = mimeTypes[format] || 'application/octet-stream';
                    const baseName = fileName.textContent.replace(/\.[^.]+$/, '');

                    // Download
                    const blob = new Blob([outputData], { type: mime });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = baseName + ext;
                    a.click();
                    URL.revokeObjectURL(url);

                    converterStatus.textContent = 'Ready';
                    converterStatus.classList.add('ready');

                } catch (err) {
                    console.error('Convert error:', err);
                    converterStatus.textContent = 'Error';
                    converterStatus.classList.add('error');
                    convertError.textContent = err.message || 'Conversion failed';
                    convertError.style.display = 'block';
                }
            }

            function updateSceneStats(scene) {
                document.getElementById('stat-nodes').textContent = scene.nodes?.length || 0;
                document.getElementById('stat-geometries').textContent = scene.geometries?.length || 0;
                document.getElementById('stat-materials').textContent = scene.materials?.length || 0;
                document.getElementById('stat-roots').textContent = scene.roots?.length || 0;
            }

            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            }
        }
    </script>
</body>
</html>
